<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ye: Tactical Ascension — Enhanced edition</title>
<style>
  :root { --ui-bg: rgba(0,0,0,0.95); --ui-border:#444; --accent:#ECFF0C; }
  html,body{height:100%}
  body{
    margin:0;padding:0;overflow:hidden;background:#050505;color:#fff;
    font-family: "Courier New", monospace;
    transition:background .3s;
  }
  canvas{display:block}
  /* UI */
  #ui,#menu,#game-over,#victory,#settings{position:absolute;text-shadow:2px 2px #000}
  #ui{top:18px;left:18px;width:380px}
  #player-hp {margin-top:6px;font-size:14px}
  .hp-bar {width:240px;height:14px;background:#111;border:1px solid #333;display:inline-block;vertical-align:middle}
  .hp-fill {height:100%;background:#ff4d4d;width:100%}
  .ability-slot{display:inline-block;width:120px;margin-right:10px}
  .cooldown-bg{width:100%;height:7px;background:#333;border:1px solid #555;margin-top:4px}
  .cooldown-fill{height:100%;background:#00ffff;width:100%}
  .muted{color:#888;font-size:12px}
  #timer-container{position:absolute;top:18px;right:18px;font-size:20px;color:#00ff00;display:none}
  #boss-ui{position:absolute;top:68px;left:50%;transform:translateX(-50%);width:60%;display:none}
  #boss-bar-bg{width:100%;height:12px;background:#222;border:1px solid #fff}
  #boss-bar-fill{width:100%;height:100%;background:#ff0000;transition:width .2s}
  #menu,#game-over,#victory{top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;background:var(--ui-bg);padding:26px;border:1px solid var(--ui-border);width:560px;z-index:1000}
  .difficulty-row{display:flex;gap:8px;margin-bottom:12px}
  .diff-btn{flex:1;padding:8px;background:#111;border:1px solid var(--ui-border);color:#999;cursor:pointer}
  .diff-btn.active{background:#222;color:#fff;border-color:#fff}
  .btn{display:block;width:100%;padding:12px;margin:8px 0;background:#111;border:1px solid var(--ui-border);cursor:pointer;color:#fff;font-size:16px}
  .btn:hover{background:#fff;color:#000}
  #crosshair{position:absolute;width:20px;height:20px;border:1px solid rgba(255,255,255,0.4);border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:2000}
  #reload-msg{position:absolute;bottom:20%;left:50%;transform:translateX(-50%);color:#ffcc00;display:none;font-weight:bold}
  #settings{top:50%;left:50%;transform:translate(-50%,-50%);width:560px;background:var(--ui-bg);border:1px solid var(--ui-border);padding:18px;z-index:1100;display:none}
  label{display:block;font-size:13px;color:#ddd;margin-bottom:6px}
  select,input[type=checkbox]{padding:6px}
  .settings-actions{display:flex;gap:8px;margin-top:12px}
</style>
</head>
<body>
<div id="crosshair" style="left:475px;top:386px"></div>
<div id="reload-msg">RELOADING...</div>

<div id="menu">
  <h1 style="letter-spacing:8px">YE ASCENSION: ENHANCED</h1>
  <p style="color:#aaa;font-size:13px;margin-bottom:8px">DEV: ApollonGorilla MOD: Groovy— Enhanced edition</p>

  <div style="font-size:12px;margin-bottom:6px;color:#aaa">DIFFICULTY</div>
  <div class="difficulty-row">
    <button class="diff-btn" id="diff-very" onclick="setDiff('very')">VERY EASY</button>
    <button class="diff-btn" id="diff-easy" onclick="setDiff('easy')">EASY</button>
    <button class="diff-btn active" id="diff-norm" onclick="setDiff('norm')">NORMAL</button>
    <button class="diff-btn" id="diff-hard" onclick="setDiff('hard')">HARD</button>
    <button class="diff-btn" id="diff-night" onclick="setDiff('night')">NIGHTMARE</button>
    <button class="diff-btn" id="diff-insane" onclick="setDiff('insane')">INSANE</button>
  </div>

  <div style="margin-bottom:8px">
    <button class="btn" onclick="startGame('P90')">P90 DLC (Primary + Quick Secondary)</button>
    <button class="btn" onclick="startGame('BOW')">BOW DLC (High Damage, Knife Secondary)</button>
    <button class="btn" onclick="startGame('ENERGY')">ENERGY RAY DLC (Fast Fire + THE BLAST)</button>
    <button class="btn" onclick="startGame('KNIFE')">KNIFE + PISTOL</button>
  </div>

  <button class="btn" onclick="openSettings()">SETTINGS (or press P)</button>
  <div class="muted" style="text-align:left;margin-top:8px">
    Controls: WASD move • Mouse aim/shoot • R reload • Q swap weapon secondary • F ability • P open settings • ESC close settings<br>
    Weapon abilities: P90 Overdrive (F) • Bow Focus Shot (F, hold) • Energy THE BLAST (F)
  </div>
</div>

<div id="ui" style="display:block">
  <div id="mode-display" style="font-weight:bold;font-size:18px">P90</div>
  <div id="difficulty-display" style="font-size:12px;color:#aaa">DIFFICULTY: NORM</div>

  <div id="player-hp">
    HP: <div class="hp-bar inline"><div id="hp-fill" class="hp-fill" style="width:100%"></div></div>
    <span id="hp-text" class="muted" style="margin-left:10px">100/100</span>
  </div>

  <div style="margin-top:8px">SCORE: <span id="score">0</span></div>
  <div id="ammo-ui" style="margin-top:6px">AMMO: <span id="ammo-count">50</span> / <span id="ammo-max">50</span></div>

  <div style="margin-top:8px" id="abilities">
    <div class="ability-slot">ABILITY (F): <div class="cooldown-bg"><div id="cd-ability" class="cooldown-fill" style="width:100%"></div></div></div>
    <div class="ability-slot">SECONDARY (Q): <div class="muted inline" id="secondary-text">knife/pistol</div></div>
  </div>
</div>

<div id="boss-ui" style="display:none">
  <div id="boss-name">BOSS</div>
  <div id="boss-bar-bg"><div id="boss-bar-fill"></div></div>
</div>

<div id="timer-container" style="display:none">0.00</div>

<div id="game-over" style="display:none">
  <h1 style="color:red">SYSTEM CRASH</h1>
  <p>SCORE: <span id="final-score">0</span></p>
  <button class="btn" onclick="location.reload()">REBOOT</button>
</div>

<div id="victory" style="display:none">
  <h1 style="color:gold">ASCENDED</h1>
  <p>FINAL TIME: <span id="victory-time">0</span></p>
  <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="settings">
  <h2 style="margin-top:0">Settings</h2>

  <div style="margin-bottom:8px">
    <label for="bg-select">Theme</label>
    <select id="bg-select">
      <option value="dark">Dark</option>
      <option value="space">Space</option>
      <option value="grid">Grid</option>
      <option value="neon">Neon</option>
      <option value="sunset">Sunset</option>
    </select>
  </div>

  <div style="margin-bottom:8px">
    <label><input type="checkbox" id="crosshair-toggle" /> Show crosshair</label>
  </div>

  <div style="margin-bottom:8px">
    <label><input type="checkbox" id="timer-toggle" /> Show speedrun timer</label>
  </div>

  <div style="margin-bottom:8px">
    <label><input type="checkbox" id="hp-toggle" /> Show player health bar</label>
  </div>

  <div style="margin-bottom:8px">
    <label><input type="checkbox" id="debug-toggle" /> Enable hit debug logs</label>
  </div>

  <div style="margin-bottom:8px">
    <label><input type="checkbox" id="sounds-toggle" /> Enable sounds</label>
  </div>

  <div class="settings-actions">
    <button class="btn" onclick="applySettings()">Apply</button>
    <button class="btn" onclick="leaveRun()">Leave Run & Back to Menu</button>
    <button class="btn" onclick="closeSettings()">Close</button>
  </div>
</div>

<canvas id="gameCanvas" width="1600" height="900"></canvas>

<script>
/* -------------------------
   Persistent settings & helpers
   ------------------------- */
const SETTINGS = {
  theme: localStorage.getItem('yta_theme') || 'dark',
  crosshair: localStorage.getItem('yta_cross') !== 'false',
  timer: localStorage.getItem('yta_timer') === 'true',
  showHP: localStorage.getItem('yta_hp') !== 'false',
  debug: localStorage.getItem('yta_debug') === 'true',
  sounds: localStorage.getItem('yta_snd') === 'true'
};
function saveSettings(){ localStorage.setItem('yta_theme', SETTINGS.theme); localStorage.setItem('yta_cross', SETTINGS.crosshair); localStorage.setItem('yta_timer', SETTINGS.timer); localStorage.setItem('yta_hp', SETTINGS.showHP); localStorage.setItem('yta_debug', SETTINGS.debug); localStorage.setItem('yta_snd', SETTINGS.sounds); }

function applyTheme(name){
  if(name === 'space') document.body.style.background = "radial-gradient(circle at 20% 20%, #0b1222, #000)";
  else if(name === 'grid') document.body.style.background = "linear-gradient(#060606,#050505), repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 40px)";
  else if(name === 'neon') document.body.style.background = "linear-gradient(#050515,#0b0012), radial-gradient(circle at 60% 30%, rgba(0,255,255,0.03), transparent)";
  else if(name === 'sunset') document.body.style.background = "linear-gradient(180deg,#2a1a3a 0%, #ff8c56 60%)";
  else document.body.style.background = "#050505";
}
applyTheme(SETTINGS.theme);
document.getElementById('crosshair').style.display = SETTINGS.crosshair ? 'block' : 'none';
document.getElementById('timer-container').style.display = SETTINGS.timer ? 'block' : 'none';
document.getElementById('hp-fill').parentElement.style.display = SETTINGS.showHP ? 'inline-block' : 'none';

/* -------------------------
   Core - canvas & refs
   ------------------------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

const ui = document.getElementById('ui');
const menu = document.getElementById('menu');
const settingsEl = document.getElementById('settings');
const timerEl = document.getElementById('timer-container');
const scoreEl = document.getElementById('score');
const ammoEl = document.getElementById('ammo-count');
const ammoMaxEl = document.getElementById('ammo-max');
const hpFill = document.getElementById('hp-fill');
const hpText = document.getElementById('hp-text');
const bossUi = document.getElementById('boss-ui');
const bossBar = document.getElementById('boss-bar-fill');
const bossName = document.getElementById('boss-name');

/* -------------------------
   Difficulty table (more levels)
   ------------------------- */
const DIFF_SETTINGS = {
  very: { speedMult:0.7, hpMult:0.5, spawnRate:140, bossMult:0.6 },
  easy: { speedMult:0.85, hpMult:0.75, spawnRate:120, bossMult:0.8 },
  norm: { speedMult:1.0, hpMult:1.0, spawnRate:90, bossMult:1.0 },
  hard: { speedMult:1.35, hpMult:1.4, spawnRate:60, bossMult:1.4 },
  night:{ speedMult:1.6, hpMult:1.9, spawnRate:45, bossMult:1.75 },
  insane:{ speedMult:2.0, hpMult:3.0, spawnRate:30, bossMult:2.4 }
};

/* -------------------------
   Weapon configs (base)
   ------------------------- */
const WEAPONS = {
  P90: { name:'P90', maxAmmo:50, reloadTime:1600, fireRate:100, damage:15, speed:20, secondary: 'P90_SECOND' },
  P90_SECOND: { name:'QuickSide', maxAmmo:3, reloadTime:600, fireRate:60, damage:6, speed:26, isSecondary:true },
  PISTOL: { name:'Pistol', maxAmmo:10, reloadTime:1100, fireRate:300, damage:75, speed:25 },
  KNIFE: { name:'Knife', maxAmmo:Infinity, reloadTime:0, fireRate:400, damage:400, speed:0 },
  BOW: { name:'Bow', maxAmmo:1, reloadTime:2400, fireRate:9999, damage:400, speed:30, secondary:'KNIFE' }, // fireRate huge to simulate long cooldown per shot
  ENERGY: { name:'Energy', maxAmmo:999999999, reloadTime:15, fireRate:35, damage:600000, speed:40, secondary:'KNIFE' } // very fast
};

/* -------------------------
   State
   ------------------------- */
let difficulty = 'norm';
let gameState = 'MENU';
let currentMode = 'P90';        // which DLC selected
let currentWeapon = 'P90';     // which actual weapon in use
let ammo = 50;
let score = 0;
let startTime = 0;
let keys = {};
let mousePos = {x:window.innerWidth/2,y:window.innerHeight/2};
let isShooting=false, lastAttack=0, frame=0;
let isReloading=false;

/* player health */
let player = { x:canvas.width/2, y:canvas.height/2, radius:20, speed:5, lunge:0, maxHP:1000000000000, hp:1000000000000 };

/* abilities state (global mapping per weapon) */
let abilityState = {
  P90: { cooldown:0, max:12000, active:false, duration:5000 },         // Overdrive
  P90_SECOND: {cooldown:0, max:4000},
  BOW: { cooldown:0, max:6000, charging:false, chargeStart:0, chargeMax:2000 }, // Focus Shot charge
  ENERGY: { cooldown:0, max:20000 }, // The Blast
  KNIFE: { cooldown:0, max:3000 }
};

/* boss / enemy arrays */
const enemies = [];
const attacks = [];
const visualFX = [];
const bossProjectiles = [];

/* boss flags + spacing */
let bossFlags = { mini:false, mid:false, late:false, final:false };
let bossActive = false;
let bossCooldown = 0; // ms between bosses
let enemiesSinceLastBoss = 0;
let lastBossTime = 0;

/* audio */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
function playTone(freq=440, dur=0.05, type='sine', vol=0.02){
  if(!audioCtx || !SETTINGS.sounds) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq; g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+dur);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
}

/* -------------------------
   helpers: UI + start/leave/settings
   ------------------------- */
function setDiff(d){ difficulty=d; document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active')); const el=document.getElementById('diff-'+d); if(el) el.classList.add('active'); document.getElementById('difficulty-display').innerText = 'DIFFICULTY: ' + d.toUpperCase(); }
function updateUI(){
  document.getElementById('mode-display').innerText = currentMode;
  const w = WEAPONS[currentWeapon];
  ammoEl.innerText = (w.maxAmmo === Infinity ? '∞' : ammo);
  ammoMaxEl.innerText = (w.maxAmmo === Infinity ? '∞' : w.maxAmmo);
  scoreEl.innerText = score;
  const hpPct = Math.max(0, Math.min(1, player.hp / player.maxHP));
  hpFill.style.width = (hpPct*100) + '%';
  hpText.innerText = Math.round(player.hp) + '/' + player.maxHP;
  // ability cd
  const ab = abilityState[currentWeapon];
  if(ab){
    const pc = 1 - Math.max(0, ab.cooldown) / (ab.max || 1);
    document.getElementById('cd-ability').style.width = (pc*100) + '%';
  }
  // secondary label
  const sec = WEAPONS[currentWeapon].secondary || (currentWeapon === 'KNIFE' ? 'Pistol' : '');
  document.getElementById('secondary-text').innerText = sec;
}

/* Settings modal */
function openSettings(){
  document.getElementById('bg-select').value = SETTINGS.theme;
  document.getElementById('crosshair-toggle').checked = SETTINGS.crosshair;
  document.getElementById('timer-toggle').checked = SETTINGS.timer;
  document.getElementById('hp-toggle').checked = SETTINGS.showHP;
  document.getElementById('debug-toggle').checked = SETTINGS.debug;
  document.getElementById('sounds-toggle').checked = SETTINGS.sounds;
  settingsEl.style.display = 'block';
}
function closeSettings(){ settingsEl.style.display = 'none'; }
function applySettings(){
  SETTINGS.theme = document.getElementById('bg-select').value;
  SETTINGS.crosshair = document.getElementById('crosshair-toggle').checked;
  SETTINGS.timer = document.getElementById('timer-toggle').checked;
  SETTINGS.showHP = document.getElementById('hp-toggle').checked;
  SETTINGS.debug = document.getElementById('debug-toggle').checked;
  SETTINGS.sounds = document.getElementById('sounds-toggle').checked;
  saveSettings();
  applyTheme(SETTINGS.theme);
  document.getElementById('crosshair').style.display = SETTINGS.crosshair ? 'block' : 'none';
  timerEl.style.display = SETTINGS.timer ? 'block' : 'none';
  document.getElementById('hp-fill').parentElement.style.display = SETTINGS.showHP ? 'inline-block' : 'none';
  closeSettings();
}
function leaveRun(){ // safe reset to menu
  gameState = 'MENU';
  enemies.length = 0; attacks.length = 0; visualFX.length = 0; bossProjectiles.length = 0;
  bossActive = false; bossFlags = {mini:false,mid:false,late:false,final:false};
  menu.style.display = 'block'; settingsEl.style.display = 'none'; document.getElementById('boss-ui').style.display = 'none';
}

/* theme apply */
function applyTheme(name){ SETTINGS.theme = name; saveSettings(); if(name==='space') document.body.style.background="radial-gradient(circle at 20% 20%, #071226,#000)"; else if(name==='grid') document.body.style.background="linear-gradient(#060606,#050505), repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 40px)"; else if(name==='neon') document.body.style.background="linear-gradient(#050515,#0b0012)"; else if(name==='sunset') document.body.style.background="linear-gradient(180deg,#2a1a3a 0%, #ff8c56 60%)"; else document.body.style.background='#050505'; }
applyTheme(SETTINGS.theme);

/* -------------------------
   Input handling
   ------------------------- */
window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    keys[k] = true;

    // Open settings
    if (k === 'p') {
        if (gameState === 'PLAYING') { openSettings(); return; }
        openSettings();
    }

    // Close settings
    if (e.key === 'Escape') {
        closeSettings();
    }

    // Only run the rest if the game is in PLAYING state
    if (gameState !== 'PLAYING') return;

    // Reload
    if (k === 'r' && !isReloading && WEAPONS[currentWeapon] && ammo < WEAPONS[currentWeapon].maxAmmo) {
        startReload();
    }

    // Swap weapon (Q key)
    if (k === 'q') {
        const weaponData = WEAPONS[currentWeapon];

        if (weaponData.secondary) {
            // Swap to secondary
            currentWeapon = weaponData.secondary;
            ammo = WEAPONS[currentWeapon].maxAmmo === Infinity ? 9999 : WEAPONS[currentWeapon].maxAmmo;
        } else if (weaponData.primary) {
            // Swap back to primary
            currentWeapon = weaponData.primary;
            ammo = WEAPONS[currentWeapon].maxAmmo === Infinity ? 9999 : WEAPONS[currentWeapon].maxAmmo;
        } else if (currentWeapon === 'KNIFE') {
            // Knife special: swap to PISTOL
            currentWeapon = 'PISTOL';
            ammo = WEAPONS[currentWeapon].maxAmmo;
        } else {
            // fallback: stay the same
            currentWeapon = currentWeapon;
        }

        updateUI();
        playTone(800, 0.06, 'square', 0.02);
    }

    // Use ability (F key)
    if (k === 'f') {
        tryUseAbility();
    }

    // Dash (Space)
    if (e.code === 'Space') {
        // Knife dash or general lunge
        if (currentWeapon === 'KNIFE' && abilityState['KNIFE']) {
            // Knife-specific dash/ability logic
            triggerKnifeDash();
        } else {
            // Generic dash
            player.lunge = 35;
            playTone(880, 0.04, 'square', 0.02);
        }
    }
});

window.addEventListener('keyup', e => {
    const k = e.key.toLowerCase();
    keys[k] = false;

    // Bow focus release
    if (k === 'f' && currentWeapon === 'BOW') {
        handleBowFocusRelease();
    }
});


window.addEventListener('mousemove', e => { mousePos.x = e.clientX; mousePos.y = e.clientY; const cross = document.getElementById('crosshair'); if(cross) { cross.style.left = e.clientX + 'px'; cross.style.top = e.clientY + 'px'; }});
window.addEventListener('mousedown', ()=> isShooting = true);
window.addEventListener('mouseup', ()=> isShooting = false);

/* -------------------------
   Weapon ability usage
   ------------------------- */
function tryUseAbility(){
  const ab = abilityState[currentWeapon];
  if(!ab) return;
  if(ab.cooldown > 0) return;
  // per weapon behaviors
  if(currentWeapon === 'P90'){
    // Overdrive: increase fire rate for duration
    ab.active = true; ab.cooldown = ab.max; setTimeout(()=>{ ab.active = false; }, ab.duration);
    playTone(1200,0.12,'sawtooth',0.03);
  } else if(currentWeapon === 'BOW'){
    // Focus shot: charge when holding F — we start charge; actual shot done on release or after charge
    ab.charging = true; ab.chargeStart = Date.now();
    // we will handle charge release on keyup (F release). Since capturing F keyup is complex here, simulate charge window: hold for up to ab.chargeMax ms
    setTimeout(()=>{ if(ab.charging){ /* auto release after max */ handleBowFocusRelease(); } }, ab.chargeMax + 20);
    playTone(600,0.08,'triangle',0.02);
  } else if(currentWeapon === 'ENERGY'){
    // THE BLAST: long-range laser
    ab.cooldown = ab.max;
    spawnEnergyBlast();
    playTone(60,0.3,'sine',0.08);
  } else if(currentWeapon === 'KNIFE'){
    ab.cooldown = ab.max;
    // quick cleave (already knife attack) - spawn bigger knife attack
    spawnKnifeArc(1.6); playTone(900,0.06,'square',0.02);
  } else if(currentWeapon === 'P90_SECOND'){
    // quick burst
    ab.cooldown = ab.max;
    spawnQuickBurst();
    playTone(1000,0.05,'square',0.02);
  }
}

/* Bow focus release (called after charge or immediate) */
function handleBowFocusRelease(){
  const ab = abilityState['BOW'];
  if(!ab || !ab.charging) return;
  const held = Math.min(Date.now() - ab.chargeStart, ab.chargeMax);
  // damage scales with held time
  const scale = 1 + (held / ab.chargeMax) * 2.0; // up to 3x
  // spawn a big arrow attack
  spawnArrow(scale);
  ab.charging = false;
  ab.cooldown = ab.max;
}

/* -------------------------
   Spawning projectiles / attacks helpers
   ------------------------- */
function spawnArrow(scale){
  const angle = Math.atan2(mousePos.y - player.y, mousePos.x - player.x);
  const atk = { x:player.x, y:player.y, vx:Math.cos(angle)*WEAPONS['BOW'].speed, vy:Math.sin(angle)*WEAPONS['BOW'].speed, life:240, damage: WEAPONS['BOW'].damage * scale, type:'BOW' };
  attacks.push(atk);
  playTone(600 + scale*200,0.12,'sine',0.03);
}

function spawnEnergyBlast(){
  // big beam — hit enemies in a line from player toward mouse. We'll apply heavy damage to enemies in cone.
  const angle = Math.atan2(mousePos.y - player.y, mousePos.x - player.x);
  // visualize with visualFX
  visualFX.push({ type:'blast', x:player.x, y:player.y, angle:angle, life: 30 });
  // apply damage to enemies in narrow cone
  for(let i=enemies.length-1;i>=0;i--){
    const en = enemies[i];
    const dx = en.x - player.x, dy = en.y - player.y;
    const dist = Math.hypot(dx,dy);
    const ang = Math.atan2(dy,dx);
    const diff = Math.abs(normalizeAngle(ang - angle));
    if(dist < 1200 && diff < 0.25){ // narrow cone
      en.hp -= 2000; // huge damage
      if(SETTINGS.debug) console.log('BLAST hit', en.type, en.hp);
      if(en.hp <= 0){
        if(en.isBoss){ bossActive=false; document.getElementById('boss-ui').style.display='none'; if(en.type==='final') triggerVictory(Date.now()-startTime); }
        enemies.splice(i,1); score += en.isBoss?2000:100;
      } else { if(en.isBoss) bossBar.style.width = (en.hp/en.maxHp*100)+'%'; }
    }
  }
}

/* quick burst for P90_SECOND */
function spawnQuickBurst(){
  for(let i=0;i<3;i++){
    const jitter = (Math.random()-0.5)*0.08;
    const angle = Math.atan2(mousePos.y-player.y, mousePos.x-player.x) + jitter;
    attacks.push({ x:player.x, y:player.y, vx:Math.cos(angle)*WEAPONS['P90_SECOND'].speed, vy:Math.sin(angle)*WEAPONS['P90_SECOND'].speed, life:200, damage:WEAPONS['P90_SECOND'].damage, type:'P90_SECOND' });
  }
}

/* knife arc */
function spawnKnifeArc(mult=1){
  // emulate an area hit by decreasing hp of nearby enemies
  for(let i=enemies.length-1;i>=0;i--){
    const en = enemies[i];
    const dist = Math.hypot(player.x - en.x, player.y - en.y);
    if(dist < 120){
      en.hp -= WEAPONS['KNIFE'].damage * mult;
      if(en.hp <= 0){ if(en.isBoss){ bossActive=false; document.getElementById('boss-ui').style.display='none'; if(en.type==='final') triggerVictory(Date.now()-startTime); } enemies.splice(i,1); score += en.isBoss?2000:100; }
    }
  }
}

/* normalize angle to [-PI, PI] */
function normalizeAngle(a){ while(a > Math.PI) a -= 2*Math.PI; while(a < -Math.PI) a += 2*Math.PI; return a; }

/* -------------------------
   Spawning enemies & bosses
   ------------------------- */
function spawnEnemy(){
  const side = Math.random() < 0.5 ? -1 : 1;
  const rx = side === -1 ? -60 : canvas.width + 60;
  const ry = Math.random() * canvas.height;
  enemies.push(makeEnemy(rx,ry,false,'normal'));
  enemiesSinceLastBoss++;
}

function makeEnemy(x,y,isBoss=false,type='normal'){
  const d = DIFF_SETTINGS[difficulty];
  const en = { x,y,isBoss,type, radius:isBoss ? (type==='mini'?60:(type==='mid'?90:(type==='late'?110:130))) : 20, speed: (isBoss?1.1:(1.5+Math.random()*1.5))*d.speedMult, armor:false };
  // HP
  if(isBoss){
    if(type==='mini') en.hp = Math.round(900 * d.hpMult * d.bossMult);
    else if(type==='mid') en.hp = Math.round(2200 * d.hpMult * d.bossMult);
    else if(type==='late') en.hp = Math.round(4200 * d.hpMult * d.bossMult * 1.2);
    else en.hp = Math.round(10000 * d.hpMult * d.bossMult * 1.5);
    en.maxHp = en.hp;
    en.attackCooldown = 0;
    en.armor = true; // bosses start with armor (damage reduction)
    en.phase = 0;
    en.lastTele = Date.now();
  } else {
    en.hp = Math.round(1 * d.hpMult);
    en.maxHp = en.hp;
  }
  return en;
}

function spawnBoss(name,type){
  bossActive = true;
  bossName.innerText = name;
  document.getElementById('boss-ui').style.display = 'block';
  bossBar.style.width = '100%';
  enemies.push(makeEnemy(canvas.width/2, -150, true, type));
  score += (type==='mini'?50:200);
  enemiesSinceLastBoss = 0;
  lastBossTime = Date.now();
  bossCooldown = 9000 + (type==='final'?6000:0);
  playTone(120,0.12,'sine',0.06);
}

/* -------------------------
   Main loop
   ------------------------- */
function animate(){
  if(gameState !== 'PLAYING') return;
  ctx.fillStyle = 'rgba(5,5,5,0.4)';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const now = Date.now();
  // Reduce boss cooldown
if(bossCooldown > 0){
    bossCooldown -= 16; // assuming animate() runs ~60fps
    if(bossCooldown < 0) bossCooldown = 0;
}

  const elapsed = now - startTime;
  if(SETTINGS.timer) timerEl.innerText = (elapsed/1000).toFixed(2);

  // reduce ability cooldowns
  Object.keys(abilityState).forEach(k => { if(abilityState[k].cooldown > 0) abilityState[k].cooldown = Math.max(0, abilityState[k].cooldown - 16); });

  // update UI
  updateUI();

  // player movement
  let moveSpeed = player.speed;
  const d = DIFF_SETTINGS[difficulty];
  player.speed = 5 * d.speedMult;
  if(keys['w']) player.y -= player.speed + player.lunge;
  if(keys['s']) player.y += player.speed + player.lunge;
  if(keys['a']) player.x -= player.speed + player.lunge;
  if(keys['d']) player.x += player.speed + player.lunge;
  player.lunge *= 0.85;
  // Clamp player inside canvas
player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));


  // draw player
  ctx.save();
  ctx.translate(player.x, player.y);
  ctx.fillStyle = '#222';
  ctx.beginPath(); ctx.arc(0,0,player.radius,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // draw enemies
for (let i = 0; i < enemies.length; i++) {
    const en = enemies[i];
    ctx.save();
    ctx.translate(en.x, en.y);
    if (en.isBoss) {
        ctx.fillStyle = 'red'; // boss color
        ctx.beginPath();
        ctx.arc(0, 0, en.radius, 0, Math.PI * 2);
        ctx.fill();
        // optional: draw boss HP bar
        ctx.fillStyle = 'black';
        ctx.fillRect(-en.radius, -en.radius - 10, en.radius * 2, 6);
        ctx.fillStyle = 'lime';
        ctx.fillRect(-en.radius, -en.radius - 10, (en.hp / en.maxHp) * en.radius * 2, 6);
    } else {
        ctx.fillStyle = 'orange'; // regular enemy color
        ctx.beginPath();
        ctx.arc(0, 0, en.radius, 0, Math.PI * 2);
        ctx.fill();
    }
    ctx.restore();
}


  // visual FX
  for(let i=visualFX.length-1;i>=0;i--){
    const fx = visualFX[i];
    if(fx.type === 'blast'){
      // draw directional beam
      ctx.save();
      ctx.globalAlpha = fx.life/30;
      ctx.translate(fx.x, fx.y);
      ctx.rotate(fx.angle);
      ctx.fillStyle = 'rgba(0,255,255,0.08)';
      ctx.fillRect(0,-8,1200,16);
      ctx.restore();
    } else {
      ctx.strokeStyle = `rgba(0,255,255,${fx.life/30})`;
      ctx.beginPath(); ctx.arc(fx.x, fx.y, fx.r+=10, 0, Math.PI*2); ctx.stroke();
    }
    fx.life--; if(fx.life<=0) visualFX.splice(i,1);
  }

  // spawn regular enemies if not in boss fight
  if(!bossActive && frame % DIFF_SETTINGS[difficulty].spawnRate === 0) spawnEnemy();

  // Boss trigger spacing logic (prevents back-to-back)
  if(!bossActive){
    if(!bossFlags.final && score >= 12000 && enemiesSinceLastBoss >= 8 && bossCooldown <= 0) { bossFlags.final=true; bossFlags.late=true; bossFlags.mid=true; bossFlags.mini=true; spawnBoss('THE SYSTEM','final'); }
    else if(!bossFlags.late && score >= 6000 && enemiesSinceLastBoss >= 6 && bossCooldown <= 0) { bossFlags.late=true; spawnBoss('THE PHANTOM','late'); }
    else if(!bossFlags.mid && score >= 2000 && enemiesSinceLastBoss >= 4 && bossCooldown <= 0) { bossFlags.mid=true; spawnBoss('THE PAPARAZZI','mid'); }
    else if(!bossFlags.mini && score >= 700 && enemiesSinceLastBoss >= 3 && bossCooldown <= 0) { bossFlags.mini=true; spawnBoss('THE HYPE','mini'); }
  }

  // Shooting (player)
  if(isShooting && !isReloading){
    const wconf = WEAPONS[currentWeapon];
    const ab = abilityState[currentWeapon];
    const fireRate = (ab && ab.active && currentWeapon==='P90') ? wconf.fireRate * 0.45 : wconf.fireRate;
    if(now - lastAttack > fireRate){
      // different weapon behaviors
      if(currentWeapon === 'BOW'){
        // one arrow then reload (simulate long charge)
        spawnArrow(1.0);
        ammo = 0;
        startReload();
      } else {
        // spawn attack projectile
        const angle = Math.atan2(mousePos.y - player.y, mousePos.x - player.x);
        attacks.push({ x:player.x, y:player.y, vx:Math.cos(angle)*wconf.speed, vy:Math.sin(angle)*wconf.speed, life:300, damage:wconf.damage, type:currentWeapon });
        ammo--;
        if(ammo <= 0 && wconf.maxAmmo !== Infinity) startReload();
      }
      lastAttack = now;
      playTone(1200,0.02,'sine',0.012);
    }
  }

  // Update attacks & collisions
  for(let i=attacks.length-1;i>=0;i--){
    const a = attacks[i];
    a.x += a.vx; a.y += a.vy; a.life--;
    // draw
    if(a.type === 'KNIFE'){ ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=10; ctx.beginPath(); ctx.arc(player.x, player.y, 90, Math.atan2(mousePos.y-player.y,mousePos.x-player.x)-1, Math.atan2(mousePos.y-player.y,mousePos.x-player.x)+1); ctx.stroke(); }
    else { ctx.fillStyle = (a.type==='P90' || a.type==='P90_SECOND')?'#ffcc00':'#fff'; ctx.beginPath(); ctx.arc(a.x,a.y,3,0,Math.PI*2); ctx.fill(); }
    if(a.life <= 0){ attacks.splice(i,1); continue; }

    // collision with enemies
    for(let j=enemies.length-1;j>=0;j--){
      const en = enemies[j];
      const dist = (a.type==='KNIFE') ? Math.hypot(player.x - en.x, player.y - en.y) : Math.hypot(a.x - en.x, a.y - en.y);
      const pr = (a.type==='KNIFE') ? 90 : 3;
      if(dist < en.radius + pr){
        // apply damage, accounting for armor
        let dmg = a.damage || 1;
        if(en.armor) dmg *= 0.45; // armor reduces damage
        en.hp -= dmg;
        if(SETTINGS.debug) console.log('HIT',a.type,'->',en.type,'dmg',dmg,'hpLeft',en.hp);
        if(a.type !== 'KNIFE') attacks.splice(i,1);
        if(en.hp <= 0){
          if(en.isBoss){
            bossActive=false; document.getElementById('boss-ui').style.display='none';
            if(en.type==='final') triggerVictory(Date.now()-startTime);
            bossCooldown = 12000;
          }
          enemies.splice(j,1);
          score += en.isBoss ? 2000 : 100;
        } else {
          if(en.isBoss) bossBar.style.width = (en.hp/en.maxHp*100) + '%';
          // boss phase handling: break armor if heavy hit (shot from special abilities)
          // if damage > threshold break armor for a while
          if(dmg > (en.maxHp * 0.08)){ en.armor = false; en.phase++; en.lastTele = Date.now(); playTone(900,0.06,'square',0.03); }
        }
        break;
      }
    }
  }

 // Boss behavior: projectiles, teleportation & armor phases
for(let i = enemies.length - 1; i >= 0; i--){
    const en = enemies[i];

    // movement toward player
    const ang = Math.atan2(player.y - en.y, player.x - en.x);
    en.x += Math.cos(ang) * en.speed;
    en.y += Math.sin(ang) * en.speed;

    if(en.isBoss){
        en.attackCooldown = (en.attackCooldown || 0) - 16;

        // teleport every certain period or when armor broken
        if(Date.now() - (en.lastTele || 0) > 4000 + en.phase*1500){
            en.x = Math.random() < 0.5 ? -120 : canvas.width + 120;
            en.y = Math.random() * canvas.height;
            en.lastTele = Date.now();
            playTone(200,0.06,'sine',0.03);
        }

        // optionally spawn projectiles toward player
        // example: boss shoots a projectile every attackCooldown
        if(en.attackCooldown <= 0){
            bossProjectiles.push({
                x: en.x,
                y: en.y,
                vx: (player.x - en.x) * 0.05,
                vy: (player.y - en.y) * 0.05,
                life: 300,
                damage: 50
            });
            en.attackCooldown = 1200; // reset cooldown
        }
    }
}



  // update bossProjectiles
  for(let i=bossProjectiles.length-1;i>=0;i--){
    const bp = bossProjectiles[i]; bp.x += bp.vx; bp.y += bp.vy; bp.life--;
    ctx.fillStyle = '#ff6666'; ctx.beginPath(); ctx.arc(bp.x,bp.y,6,0,Math.PI*2); ctx.fill();
    if(bp.life <=0) { bossProjectiles.splice(i,1); continue; }
    if(Math.hypot(bp.x - player.x, bp.y - player.y) < player.radius + 6){
      // player takes damage
      player.hp -= bp.damage;
      if(SETTINGS.debug) console.log('PLAYER HIT, HP:',player.hp);
      bossProjectiles.splice(i,1);
      playTone(80,0.18,'sawtooth',0.06);
      if(player.hp <= 0){ gameState = 'GAMEOVER'; document.getElementById('game-over').style.display='block'; document.getElementById('final-score').innerText = score; return; }
    }
  }

  // check enemies touching player -> damage & knockback
  for(let i=enemies.length-1;i>=0;i--){
    const en = enemies[i];
    if(Math.hypot(en.x - player.x, en.y - player.y) < player.radius + en.radius - 6){
      // small damage & player lunge
      const dmg = en.isBoss ? 18 * DIFF_SETTINGS[difficulty].hpMult : 12 * DIFF_SETTINGS[difficulty].hpMult;
      player.hp += dmg;
      player.lunge = -20;
      playTone(100,0.12,'sawtooth',0.04);
      if(player.hp <= 0){ gameState = 'GAMEOVER'; document.getElementById('game-over').style.display='block'; document.getElementById('final-score').innerText = score; return; }
    }
  }

  frame++;
  requestAnimationFrame(animate);
}

/* -------------------------
   reload & start/stop functions
   ------------------------- */
function startReload(){
  if(isReloading) return;
  isReloading = true;
  const w = WEAPONS[currentWeapon];
  const t = w.reloadTime || 1000;
  document.getElementById('reload-msg').style.display = 'block';
  setTimeout(()=>{ ammo = w.maxAmmo === Infinity ? 9999 : w.maxAmmo; isReloading = false; document.getElementById('reload-msg').style.display = 'none'; updateUI(); }, t);
}

/* -------------------------
   Bow charge release detection (F key hold)
   ------------------------- */
let bowHoldInterval = null;
window.addEventListener('keyup', e => {
  if(e.key.toLowerCase() === 'f' && abilityState['BOW'] && abilityState['BOW'].charging){
    // release bow charge
    const ab = abilityState['BOW'];
    const held = Math.min(Date.now() - ab.chargeStart, ab.chargeMax);
    ab.charging = false; ab.cooldown = ab.max;
    const scale = 1 + (held / ab.chargeMax) * 2.5;
    spawnArrow(scale);
    playTone(900 + scale*120,0.12,'triangle',0.04);
  }
});

/* -------------------------
   Weapon selection & startGame
   ------------------------- */
function startGame(mode){
  currentMode = mode;
  if(mode === 'P90'){ currentWeapon = 'P90'; ammo = WEAPONS['P90'].maxAmmo; } 
  else if(mode === 'BOW'){ currentWeapon = 'BOW'; ammo = WEAPONS['BOW'].maxAmmo; }
  else if(mode === 'ENERGY'){ currentWeapon = 'ENERGY'; ammo = WEAPONS['ENERGY'].maxAmmo; }
  else { currentWeapon = 'KNIFE'; ammo = 9999; }
  // reset player
  player.x = canvas.width/2; player.y = canvas.height/2; player.hp = player.maxHP = 100 * DIFF_SETTINGS[difficulty].hpMult;
  score = 0; startTime = Date.now(); gameState = 'PLAYING';
  menu.style.display = 'none'; settingsEl.style.display = 'none';
  bossFlags = {mini:false,mid:false,late:false,final:false}; bossActive=false; bossCooldown=0; enemiesSinceLastBoss=0;
  enemies.length=0; attacks.length=0; visualFX.length=0; bossProjectiles.length=0;
  updateUI();
  animate();
}

/* -------------------------
   Victory handling
   ------------------------- */
function triggerVictory(time){
  gameState = 'VICTORY';
  document.getElementById('victory').style.display = 'block';
  document.getElementById('victory-time').innerText = (time/1000).toFixed(2) + 's';
}

/* -------------------------
   Initial UI wiring & expose debug
   ------------------------- */
document.getElementById('bg-select').value = SETTINGS.theme;
document.getElementById('crosshair-toggle').checked = SETTINGS.crosshair;
document.getElementById('timer-toggle').checked = SETTINGS.timer;
document.getElementById('hp-toggle').checked = SETTINGS.showHP;
document.getElementById('debug-toggle').checked = SETTINGS.debug;
document.getElementById('sounds-toggle').checked = SETTINGS.sounds;
updateUI();
setDiff('norm');

window._DEBUG = { enemies, attacks, player, SETTINGS, spawnBoss };

/* -------------------------
   Save/load settings helpers
   ------------------------- */
function saveSettings(){
  localStorage.setItem('yta_theme', SETTINGS.theme);
  localStorage.setItem('yta_cross', SETTINGS.crosshair);
  localStorage.setItem('yta_timer', SETTINGS.timer);
  localStorage.setItem('yta_hp', SETTINGS.showHP);
  localStorage.setItem('yta_debug', SETTINGS.debug);
  localStorage.setItem('yta_snd', SETTINGS.sounds);
}
/* expose functions called from UI */
window.openSettings = openSettings;
window.closeSettings = closeSettings;
window.applySettings = function(){ SETTINGS.theme = document.getElementById('bg-select').value; SETTINGS.crosshair = document.getElementById('crosshair-toggle').checked; SETTINGS.timer = document.getElementById('timer-toggle').checked; SETTINGS.showHP = document.getElementById('hp-toggle').checked; SETTINGS.debug = document.getElementById('debug-toggle').checked; SETTINGS.sounds = document.getElementById('sounds-toggle').checked; saveSettings(); applyTheme(SETTINGS.theme); document.getElementById('crosshair').style.display = SETTINGS.crosshair ? 'block' : 'none'; document.getElementById('timer-container').style.display = SETTINGS.timer ? 'block' : 'none'; document.getElementById('hp-fill').parentElement.style.display = SETTINGS.showHP ? 'inline-block' : 'none'; closeSettings(); };
window.leaveRun = leaveRun;
window.startGame = startGame;
</script>
</body>
</html>
